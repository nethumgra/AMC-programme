<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materials - AMC BRIDGE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>

    <style>
        :root {
            --primary-color: #7c3aed;
            --primary-hover: #6d28d9;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Sidebar Styles --- */
        .sidebar-nav {
            width: 260px;
            background: white;
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-left: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: 0.2s;
        }

        .nav-item:hover { background: #f5f3ff; color: var(--primary-color); }
        .nav-item.active { background: #f5f3ff; color: var(--primary-color); font-weight: 600; }

        /* --- Main Content Area --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-header {
            height: 70px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            flex-shrink: 0;
        }

        .breadcrumbs { font-size: 0.9rem; color: var(--text-light); }
        .breadcrumbs span { color: var(--text-main); font-weight: 500; }

        .user-actions { display: flex; gap: 15px; align-items: center; }
        .btn-logout {
            padding: 8px 16px;
            border: 1px solid #fee2e2;
            background: #fff1f2;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #991b1b;
            transition: 0.2s;
        }
        .btn-logout:hover { background: #fee2e2; }

        /* --- Materials Content --- */
        .content-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .materials-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .materials-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }

        .search-bar {
            position: relative;
            width: 300px;
        }
        .search-bar input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            outline: none;
            font-family: 'Inter', sans-serif;
        }
        .search-bar input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        .search-bar i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* --- Category Tabs --- */
        .category-tabs-wrapper {
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        .category-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            min-width: max-content;
        }
        .tab-btn {
            padding: 8px 18px;
            border-radius: 20px;
            border: 1.5px solid var(--border-color);
            background: white;
            color: var(--text-light);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-family: 'Inter', sans-serif;
        }
        .tab-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f5f3ff; }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- PDF List Styling --- */
       /* පරණ #pdf-list එක මකලා මේක දාන්න */
#pdf-list {
    list-style: none;
    display: flex;              /* Grid වෙනුවට Flex පාවිච්චි කරනවා */
    flex-direction: column;     /* පේලියට යටින් යට එන්න */
    gap: 15px;                  /* කාඩ් අතර පරතරය */
    padding-bottom: 50px;       
}/* පරණ .material-card එක මකලා මේක දාන්න */
.material-card {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;                /* Screen එකේ සම්පූර්ණ පළල ගන්න */
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

        .material-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.1);
        }

        .icon-box {
            width: 45px;
            height: 45px;
            background: #f5f3ff;
            color: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .material-info {
            overflow: hidden;
        }

       /* පරණ .material-title එක මකලා මේක දාන්න */
.material-title {
    font-weight: 600;
    color: var(--text-main);
    font-size: 1.05rem;
    
    /* මේ යට තියෙන ටික අයින් කරපු නිසා දැන් නම සම්පූර්ණයෙන්ම පේනවා */
    /* white-space: nowrap;  <-- මකලා */
    /* overflow: hidden;     <-- මකලා */
    /* text-overflow: ellipsis; <-- මකලා */
    
    margin-bottom: 4px;
    line-height: 1.4; /* පේළි අතර පරතරය */
}
        .material-type {
            font-size: 0.8rem;
            color: var(--text-light);
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        /* --- PRO PDF VIEWER MODAL --- */
        #pdf-viewer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; 
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar */
        .pdf-toolbar {
            height: 60px;
            background: #1f2937;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .pdf-title-area { font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .pdf-controls { display: flex; align-items: center; gap: 15px; }
        
        .viewer-btn {
            background: rgba(255,255,255,0.1);
            border: none; color: white;
            padding: 8px 12px; border-radius: 6px;
            cursor: pointer; font-size: 0.9rem;
            transition: 0.2s;
        }
        .viewer-btn:hover { background: rgba(255,255,255,0.2); }
        .close-btn { background: #ef4444; }
        .close-btn:hover { background: #dc2626; }

        /* Main Viewer Layout (Split View) */
        .pdf-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #e5e7eb; 
            position: relative;
        }

        /* Sidebar Thumbnails */
        .pdf-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
            z-index: 5; 
        }

        .thumbnail-wrapper {
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            opacity: 0.7;
        }
        .thumbnail-wrapper:hover { opacity: 1; }
        .thumbnail-wrapper.active { opacity: 1; }
        .thumbnail-wrapper.active canvas { border: 3px solid var(--primary-color); }

        .thumbnail-canvas {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .page-label { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; }

        /* Main Canvas Area */
       /* Main Canvas Area (Scrollable Parent) */
#pdf-viewer-content {
    flex: 1;
    overflow: auto;       /* Scrollbars එන්න ඕන වුනාම එනවා */
    padding: 30px;
    display: block;       /* Flex අයින් කරලා Block දානවා (මෙකෙන් තමයි වම් පැත්තට යට වෙන එක නවතින්නේ) */
    position: relative;
    z-index: 2;
    text-align: center;   /* PDF එක පොඩි නම් මැදට ගන්න */
}

/* Inner Container holding the pages */
#pdf-canvas-container {
    display: inline-flex; /* content එකේ size එකටම width එක හැදෙන්න */
    flex-direction: column;
    gap: 20px;
    align-items: center;
    margin: 0 auto;       /* ලොකු වුනත් පොඩි වුනත් මැදටම එන්න */
}

        .pdf-page-canvas {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
        }

        /* --- Watermark (FIXED OVERLAY - Gray & Clean) --- */
        @keyframes pan-grid { 0% { transform: translate(0, 0); } 50% { transform: translate(-40px, -20px); } 100% { transform: translate(0, 0); } }
        
        .full-coverage-watermark { 
            position: absolute; 
            top: 0; 
            left: 250px; 
            width: calc(100% - 250px); 
            height: 100%; 
            z-index: 99; 
            pointer-events: none; 
            display: flex; 
            flex-wrap: wrap; 
            align-items: flex-start; 
            justify-content: center; 
            overflow: hidden; 
            animation: pan-grid 25s linear infinite; 
        }
        
        .watermark-item { 
            /* Balanced Gray visibility */
            color: rgba(0, 0, 0, 0.15); 
            font-size: 16px; 
            font-weight: 400; 
            padding: 50px; 
            transform: rotate(-30deg); 
            white-space: nowrap; 
            text-shadow: none;
        }

        /* --- Loaders --- */
        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: var(--text-light); gap: 15px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- SECURITY CHECK ANIMATION STYLES --- */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .popup-content { background: white; padding: 40px; border-radius: 16px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 400px; }

        .security-check-list {
            list-style: none;
            padding: 0;
            margin: 20px 0 0 0;
            width: 100%;
            text-align: left;
        }

        .security-check-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
            color: var(--text-light);
            font-size: 0.95rem;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .security-check-item.active {
            opacity: 1;
            color: var(--primary-color);
            font-weight: 600;
        }

        .security-check-item.completed {
            opacity: 1;
            color: #059669; /* Green */
            font-weight: 500;
        }

        .check-icon {
            width: 20px;
            display: flex;
            justify-content: center;
        }

        .step-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* --- SECURITY OVERLAY (Tab Lock) --- */
        .security-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .security-overlay.active { display: flex; }
        .security-icon { font-size: 4rem; color: #ef4444; margin-bottom: 20px; }
        .security-title { font-size: 2rem; font-weight: 800; margin-bottom: 10px; color: #ef4444; text-transform: uppercase; }
        .security-msg { font-size: 1.1rem; color: #d1d5db; margin-bottom: 30px; max-width: 500px; line-height: 1.5; }
        
        .verify-btn { padding: 15px 40px; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .verify-btn:hover { background: var(--primary-hover); transform: scale(1.02); }

        /* Loader for Tab Lock Security */
        .loader-circle { border: 4px solid rgba(255,255,255,0.3); border-left-color: var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .success-icon { font-size: 4rem; color: #22c55e; margin-bottom: 15px; display: none; animation: popIn 0.5s ease; }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar-nav { display: none; }
            #pdf-list { grid-template-columns: 1fr; }
            .pdf-sidebar { display: none; } 
            .full-coverage-watermark { left: 0; width: 100%; } 
        }
    </style>
</head>
<body>

    <div id="securityOverlay" class="security-overlay">
        <div id="warningContent" style="display: flex; flex-direction: column; align-items: center;">
            <i class="fas fa-exclamation-triangle security-icon"></i>
            <div class="security-title">Security Alert</div>
            <p class="security-msg">Don't try to screen record or switch tabs. Your activity has been flagged. Please verify you are active to resume.</p>
            <button id="verifyBtn" class="verify-btn"><i class="fas fa-user-shield"></i> Resume</button>
        </div>
        <div id="loadingContent" style="display: none; flex-direction: column; align-items: center;">
            <div class="loader-circle"></div>
            <p style="font-size: 1.1rem; color: #ccc;">Verifying...</p>
        </div>
        <div id="successContent" style="display: none; flex-direction: column; align-items: center;">
            <i class="fas fa-check-circle success-icon" style="display: block;"></i>
            <div class="security-title" style="color: #22c55e;">Verified!</div>
        </div>
    </div>

    <aside class="sidebar-nav">
        <div class="brand"><i class="fas fa-graduation-cap"></i> AMC BRIDGE</div>
        <a href="#" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
        <a href="#" class="nav-item active"><i class="fas fa-book"></i> Materials</a>
        <a href="index.html" class="nav-item"><i class="fas fa-play-circle"></i> Courses</a>
        <div style="margin-top: auto;">
            <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div class="breadcrumbs">Dashboard / AMC Programme / <span>Materials</span></div>
            <div class="user-actions">
                <button class="btn-logout">Logout</button>
            </div>
        </header>

        <div class="content-scroll-area">
            <div class="materials-header">
                <h1>Course Materials</h1>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="pdfSearch" placeholder="Search files...">
                </div>
            </div>
            
            <!-- Category Tabs - Dynamically loaded from Firestore -->
            <div class="category-tabs-wrapper">
                <div class="category-tabs" id="categoryTabs">
                    <button class="tab-btn active" data-cat="All">All</button>
                    <!-- Dynamic tabs injected here by JS -->
                </div>
            </div>

            <ul id="pdf-list">
                <div class="loader-container"><div class="spinner"></div><span>Loading library...</span></div>
            </ul>
        </div>
    </main>

    <template id="pdfViewerTemplate">
        <div id="pdf-viewer-modal">
            <div class="pdf-toolbar">
                <div class="pdf-title-area">
                    <i class="fas fa-file-pdf" style="color:#ef4444;"></i>
                    <span id="pdf-viewer-title">Document Name</span>
                </div>
                <div class="pdf-controls">
                    <span id="page-render-status" style="font-size:0.85rem; opacity:0.8;">Loading...</span>
                    <button class="viewer-btn close-btn" id="pdf-viewer-close"><i class="fas fa-times"></i> Close</button>
                </div>
            </div>
            
            <div class="pdf-body">
                <div id="pdf-sidebar" class="pdf-sidebar">
                    </div>

                <div id="pdf-viewer-content">
                     <div id="pdf-canvas-container">
                        </div>
                </div>

                <div id="pdf-watermark" class="full-coverage-watermark"></div>
            </div>
        </div>
    </template>
    
    <template id="loadingPopupTemplate">
        <div class="popup-overlay">
            <div class="popup-content">
                <h3 style="margin:0 0 10px 0; color:#1f2937; font-size:1.2rem;">Security Verification</h3>
                <p style="margin:0; font-size:0.9rem; color:#6b7280;">Establishing secure connection...</p>
                
                <ul class="security-check-list">
                    <li class="security-check-item" id="step-1">
                        <div class="check-icon"><i class="far fa-circle"></i></div>
                        <span>Verifying User Session</span>
                    </li>
                    <li class="security-check-item" id="step-2">
                        <div class="check-icon"><i class="far fa-circle"></i></div>
                        <span>Checking Device Integrity</span>
                    </li>
                    <li class="security-check-item" id="step-3">
                        <div class="check-icon"><i class="far fa-circle"></i></div>
                        <span>Establishing Encrypted Tunnel</span>
                    </li>
                    <li class="security-check-item" id="step-4">
                        <div class="check-icon"><i class="far fa-circle"></i></div>
                        <span>Decrypting Document</span>
                    </li>
                </ul>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzv4pdvSb6CEQrnGZ6qBc_gZWledDBI1XZ9FsP2hYTUd6YQ4bBCmFDjT2WdtpaHFBDjw/exec";
        
        const firebaseConfig = {
            apiKey: "AIzaSyASA8KptfOy9pezf3QCoWHt9Bg28yN3HsM",
            authDomain: "amce-5d785.firebaseapp.com",
            projectId: "amce-5d785",
            storageBucket: "amce-5d785.appspot.com",
            messagingSenderId: "877483628426",
            appId: "1:877483628426:web:dfd8961b06c35e6cc95a73"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        // Security Logic Variables
        const securityOverlay = document.getElementById('securityOverlay');
        const verifyBtn = document.getElementById('verifyBtn');
        let isLocked = false;
        
        // --- SECURITY LOCK (Tab Switching) ---
        function lockScreen() {
            if(isLocked || !auth.currentUser) return;
            // Only lock if PDF viewer is currently active
            if(document.getElementById('pdf-viewer-modal')) {
                isLocked = true;
                document.getElementById('warningContent').style.display = 'flex';
                document.getElementById('loadingContent').style.display = 'none';
                document.getElementById('successContent').style.display = 'none';
                securityOverlay.classList.add('active');
            }
        }

        verifyBtn.addEventListener('click', () => {
            document.getElementById('warningContent').style.display = 'none';
            document.getElementById('loadingContent').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loadingContent').style.display = 'none';
                document.getElementById('successContent').style.display = 'flex';
                setTimeout(() => {
                    securityOverlay.classList.remove('active');
                    isLocked = false;
                }, 1500);
            }, 2000);
        });

        const handleVisibilityChange = () => { if (document.hidden) lockScreen(); };
        const handleMouseLeave = () => { lockScreen(); };

        function setupSecurity() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.documentElement.addEventListener('mouseleave', handleMouseLeave);
        }

       // --- AUTH & LOGIC ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // කෙලින්ම emailVerified බලන්නේ නැතුව, DB එකෙන් User Approved ද කියල බලමු
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            
            if (userDoc.exists() && userDoc.data().isApproved === true) {
                // Admin approve කරලා නම් විතරක් access දෙන්න
                setupSecurity();
                // Watermark එකත් මෙතනම load කරගන්න පුළුවන්
                populateWatermark('#pdf-watermark'); 
            } else {
                // User හිටියට approve කරලා නැත්නම් එලියට දානවා
                alert("Your account is pending approval or suspended.");
                window.location.href = 'index.html';
            }
        } catch (error) {
            console.error("Error checking user status:", error);
            window.location.href = 'index.html';
        }
    } else {
        // User කෙනෙක් login වෙලා නැත්නම් එලියට දානවා
        window.location.href = 'index.html';
    }
});

        document.querySelector('.btn-logout').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'index.html');
        });

        // Fetch PDFs
        let allPdfs = [];
        let activeCategory = 'All';
        let searchTerm = '';

        // --- Load Categories Dynamically from Firestore ---
        const catsQuery = query(collection(db, "categories"), orderBy("order", "asc"));
        onSnapshot(catsQuery, (snapshot) => {
            const tabsContainer = document.getElementById('categoryTabs');
            // Keep the "All" button, rebuild the rest
            tabsContainer.innerHTML = '<button class="tab-btn active" data-cat="All">All</button>';
            snapshot.forEach((d) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.dataset.cat = d.data().name;
                btn.textContent = d.data().name;
                tabsContainer.appendChild(btn);
            });
        });
        
        const pdfsQuery = query(collection(db, "pdfs"), orderBy("createdAt", "desc"));
        onSnapshot(pdfsQuery, (snapshot) => {
            allPdfs = [];
            snapshot.forEach((doc) => {
                allPdfs.push({ id: doc.id, ...doc.data() });
            });
            renderPdfList();
        });
        
        function renderPdfList() {
            const pdfListEl = document.getElementById('pdf-list');
            
            const filtered = allPdfs.filter(pdf => {
                const matchCat = activeCategory === 'All' || (pdf.category || 'Uncategorized') === activeCategory;
                const matchSearch = pdf.title.toLowerCase().includes(searchTerm);
                return matchCat && matchSearch;
            });
            
            pdfListEl.innerHTML = '';
            if (filtered.length === 0) {
                pdfListEl.innerHTML = '<div style="text-align:center; color:#888; padding:50px; width:100%;">No materials found in this category.</div>';
                return;
            }
            filtered.forEach((pdf) => {
                const catLabel = pdf.category || 'Uncategorized';
                const catColor = getCategoryColor(catLabel);
                const listItem = document.createElement('li');
                listItem.className = 'material-card';
                listItem.innerHTML = `
                    <div class="icon-box"><i class="fas fa-file-pdf"></i></div>
                    <div class="material-info" style="flex:1;">
                        <div class="material-title">${pdf.title}</div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                            <span class="material-type">PDF Document</span>
                            <span style="font-size:0.78rem; padding:2px 10px; border-radius:10px; font-weight:600; background:${catColor.bg}; color:${catColor.text};">${catLabel}</span>
                        </div>
                    </div>
                `;
                listItem.addEventListener('click', () => openPdfViewer(pdf.url, pdf.title, pdf.fileId));
                pdfListEl.appendChild(listItem);
            });
        }
        
        // Generate a consistent pastel color from any string
        function getCategoryColor(cat) {
            // Predefined colors for common subjects
            const map = {
                'Anatomy':            { bg:'#fce7f3', text:'#9d174d' },
                'Physiology':         { bg:'#d1fae5', text:'#065f46' },
                'Biochemistry':       { bg:'#dbeafe', text:'#1e40af' },
                'Pathology':          { bg:'#fee2e2', text:'#991b1b' },
                'Pharmacology':       { bg:'#ede9fe', text:'#5b21b6' },
                'Microbiology':       { bg:'#fef3c7', text:'#92400e' },
                'Surgery':            { bg:'#fce7f3', text:'#831843' },
                'Medicine':           { bg:'#e0f2fe', text:'#0c4a6e' },
                'OBG':                { bg:'#fdf2f8', text:'#9333ea' },
                'Pediatrics':         { bg:'#ecfdf5', text:'#047857' },
                'Community Medicine': { bg:'#f0fdf4', text:'#166534' },
                'Uncategorized':      { bg:'#f3f4f6', text:'#374151' },
            };
            if (map[cat]) return map[cat];
            // Auto-generate color for any other category name
            let hash = 0;
            for (let i = 0; i < cat.length; i++) hash = cat.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash) % 360;
            return { bg: `hsl(${hue}, 70%, 92%)`, text: `hsl(${hue}, 60%, 30%)` };
        }

        // Tab click logic
        document.getElementById('categoryTabs').addEventListener('click', (e) => {
            const btn = e.target.closest('.tab-btn');
            if (!btn) return;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeCategory = btn.dataset.cat;
            renderPdfList();
        });

        const searchInput = document.getElementById('pdfSearch');
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            renderPdfList();
        });

        function hideLoadingPopup() {
            const popup = document.querySelector('.popup-overlay');
            if (popup) popup.remove();
        }
        
        async function populateWatermark(containerSelector) {
            const watermarkContainer = document.querySelector(containerSelector);
            if (!watermarkContainer || !auth.currentUser) return;
            const userDocRef = doc(db, "users", auth.currentUser.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                const { username, mobile } = userDocSnap.data();
                const details = `${username} / ${auth.currentUser.email} / ${mobile}`;
                let html = '';
                for (let i = 0; i < 200; i++) html += `<span class="watermark-item">${details}</span>`;
                watermarkContainer.innerHTML = html;
            }
        }

        // --- SECURITY CHECK ANIMATION LOGIC ---
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function runSecurityCheckSequence() {
            const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
            for (const stepId of steps) {
                const el = document.getElementById(stepId);
                const iconContainer = el.querySelector('.check-icon');
                // Set Active
                el.classList.add('active');
                iconContainer.innerHTML = '<div class="step-spinner"></div>';
                // Random Delay
                await wait(Math.floor(Math.random() * 500) + 400);
                // Set Completed
                el.classList.remove('active');
                el.classList.add('completed');
                iconContainer.innerHTML = '<i class="fas fa-check-circle"></i>';
            }
            await wait(500);
        }

        // --- OPEN PDF FUNCTION (With Animation) ---
        async function openPdfViewer(driveUrl, pdfTitle, fileIdFromDb) {
            let fileId = fileIdFromDb;
            if (!fileId) {
                const regex = /id=([a-zA-Z0-9_-]+)/;
                const match = driveUrl.match(regex);
                if (!match || !match[1]) { alert("Invalid PDF link."); return; }
                fileId = match[1];
            }

            // Show Security Check Popup
            const template = document.getElementById('loadingPopupTemplate').content.cloneNode(true);
            document.body.appendChild(template);

            try {
                // Run Animation & Fetch Data
                const [animationResult, apiResponse] = await Promise.all([
                    runSecurityCheckSequence(), 
                    fetch(`${SCRIPT_URL}?fileId=${fileId}`)
                ]);

                const data = await apiResponse.json();
                if (data.status !== 'success') throw new Error(data.message);

                hideLoadingPopup();
                const pdfDataBinary = atob(data.data);
                
                // Open Modal
                const viewerTemplate = document.getElementById('pdfViewerTemplate').content.cloneNode(true);
                document.body.appendChild(viewerTemplate);
                
                document.getElementById('pdf-viewer-title').textContent = pdfTitle;
                document.getElementById('pdf-viewer-close').addEventListener('click', () => {
                    document.getElementById('pdf-viewer-modal').remove();
                });

                await populateWatermark('#pdf-watermark');
                
                const pdfDoc = await pdfjsLib.getDocument({ data: pdfDataBinary }).promise;
                const canvasContainer = document.getElementById('pdf-canvas-container');
                const sidebarContainer = document.getElementById('pdf-sidebar');
                
                renderAllPages(pdfDoc, canvasContainer, sidebarContainer);

            } catch (err) {
                hideLoadingPopup();
                alert("Security verification failed or network error.");
                console.error("Error:", err);
            }
        }

        async function renderAllPages(pdfDoc, mainContainer, sidebarContainer) {
            const statusEl = document.getElementById('page-render-status');
            
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                if (statusEl) statusEl.textContent = `Rendering ${pageNum} / ${pdfDoc.numPages}`;
                
                // Main Page
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                canvas.id = `page-${pageNum}`; 
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                mainContainer.appendChild(canvas);

                // Thumbnail
                const thumbViewport = page.getViewport({ scale: 0.2 });
                const thumbCanvas = document.createElement('canvas');
                thumbCanvas.className = 'thumbnail-canvas';
                const thumbCtx = thumbCanvas.getContext('2d');
                thumbCanvas.height = thumbViewport.height;
                thumbCanvas.width = thumbViewport.width;

                const thumbWrapper = document.createElement('div');
                thumbWrapper.className = 'thumbnail-wrapper';
                thumbWrapper.innerHTML = `<div class="page-label">Page ${pageNum}</div>`;
                thumbWrapper.insertBefore(thumbCanvas, thumbWrapper.firstChild);
                
                thumbWrapper.addEventListener('click', () => {
                    const targetPage = document.getElementById(`page-${pageNum}`);
                    if(targetPage) targetPage.scrollIntoView({ behavior: 'smooth' });
                    document.querySelectorAll('.thumbnail-wrapper').forEach(el => el.classList.remove('active'));
                    thumbWrapper.classList.add('active');
                });

                sidebarContainer.appendChild(thumbWrapper);
                page.render({ canvasContext: thumbCtx, viewport: thumbViewport });
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            if (statusEl) statusEl.textContent = `${pdfDoc.numPages} Pages`;
        }

        // Global Security
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.key === "F12" || (e.ctrlKey && (e.key === 'p' || e.key === 's' || e.key === 'u'))) {
                e.preventDefault();
            }
        });
    </script>

</body>
</html>