<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AMC BRIDGE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7c3aed;
            --primary-dark: #5b21b6;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body { background-color: var(--bg-body); color: var(--text-dark); height: 100vh; display: flex; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #admin-login-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #7c3aed, #4c1d95);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 16px;
            width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
        }

        .login-card h2 { margin-bottom: 20px; color: var(--primary-color); }

        .login-input {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 1px solid #e2e8f0; border-radius: 8px; outline: none;
        }
        .login-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }

        .login-btn {
            width: 100%; padding: 12px; background: var(--primary-color);
            color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        .login-btn:hover { background: var(--primary-dark); }

        /* --- DASHBOARD LAYOUT --- */
        .sidebar {
            width: 260px; background: white; border-right: 1px solid #e2e8f0;
            display: flex; flex-direction: column; padding: 20px; flex-shrink: 0;
        }

        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        
        .nav-links { list-style: none; }
        .nav-links li { margin-bottom: 8px; }
        .nav-btn {
            width: 100%; text-align: left; padding: 12px 15px;
            background: none; border: none; border-radius: 8px;
            color: var(--text-light); font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 12px; transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: #f5f3ff; color: var(--primary-color); }
        .nav-btn i { width: 20px; }

        .main-content { flex: 1; overflow-y: auto; padding: 30px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 1.8rem; font-weight: 700; }
        
        .logout-btn {
            background: #fee2e2; color: #991b1b; border: none; padding: 8px 16px;
            border-radius: 8px; cursor: pointer; font-weight: 600;
        }

        /* --- CARDS & SECTIONS --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px;
        }
        .stat-icon {
            width: 50px; height: 50px; border-radius: 10px; background: #f5f3ff;
            color: var(--primary-color); display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
        }
        .stat-info h3 { font-size: 1.5rem; margin: 0; }
        .stat-info p { color: var(--text-light); font-size: 0.9rem; margin: 0; }

        .content-section { display: none; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card h3 { margin-bottom: 20px; color: var(--text-dark); border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }

        /* --- SEARCH & FILTER BAR --- */
        .filter-bar {
            display: flex; gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px;
        }
        .search-input {
            flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none;
        }
        .filter-select {
            padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; background: white;
        }

        /* --- FORMS --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-field {
            width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; outline: none;
        }
        .input-field:focus { border-color: var(--primary-color); }
        
        .submit-btn {
            background: var(--primary-color); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .submit-btn:hover { background: var(--primary-dark); }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: var(--text-light); font-weight: 600; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 0.95rem; vertical-align: middle; }
        tr:hover { background: #f8fafc; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge.pending { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .badge.active { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }

        .action-btn {
            padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; margin-right: 5px; transition: 0.2s;
        }
        .btn-delete { background: #fee2e2; color: #991b1b; }
        .btn-delete:hover { background: #fecaca; }
        .btn-reset { background: #f3f4f6; color: #374151; }
        .btn-reset:hover { background: #e5e7eb; }
        .btn-approve { background: #d1fae5; color: #065f46; }
        .btn-approve:hover { background: #a7f3d0; }
        .btn-suspend { background: #ffedd5; color: #9a3412; }
        .btn-suspend:hover { background: #fed7aa; }
        
        .migrate-btn {
            background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 15px; font-weight: 600;
        }
        .migrate-btn:hover { background: #2563eb; }

        /* --- CUSTOM MODALS (NEW) --- */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .custom-modal {
            background: white; padding: 30px; border-radius: 16px;
            width: 90%; max-width: 450px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            transform: scale(0.9); animation: scaleUp 0.2s ease forwards;
        }

        @keyframes scaleUp { to { transform: scale(1); } }

        .modal-icon { font-size: 3rem; margin-bottom: 20px; display: block; }
        .modal-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); }
        .modal-msg { color: var(--text-light); margin-bottom: 30px; font-size: 1rem; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn {
            padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; flex: 1;
        }
        .btn-cancel { background: #f1f5f9; color: var(--text-dark); }
        .btn-cancel:hover { background: #e2e8f0; }
        .btn-confirm-danger { background: var(--danger); color: white; }
        .btn-confirm-danger:hover { background: #dc2626; }
        .btn-confirm-success { background: var(--success); color: white; }
        .btn-confirm-success:hover { background: #059669; }
        .btn-confirm-primary { background: var(--primary-color); color: white; }
        .btn-confirm-primary:hover { background: var(--primary-dark); }

        /* Utility */
        .hidden { display: none !important; }
        .message { margin-top: 10px; font-size: 0.9rem; }
        .error { color: var(--danger); }
        .success { color: var(--success); }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .form-grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="admin-login-view">
        <div class="login-card">
            <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
            <form id="adminLoginForm">
                <input type="email" id="adminEmail" class="login-input" placeholder="Admin Email" required>
                <input type="password" id="adminPassword" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-btn">Login</button>
                <p id="loginError" class="message error"></p>
            </form>
        </div>
    </div>

    <div id="admin-dashboard-view" class="hidden" style="width:100%; height:100%; display:flex;">
        
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i> AMC Admin</div>
            <ul class="nav-links">
                <li><button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</button></li>
                <li><button class="nav-btn" onclick="switchTab('users')"><i class="fas fa-users"></i> Manage Users</button></li>
                <li><button class="nav-btn" onclick="switchTab('content')"><i class="fas fa-upload"></i> Upload Content</button></li>
                <li><button class="nav-btn" onclick="switchTab('manage-videos')"><i class="fas fa-video"></i> Manage Videos</button></li>
                <li><button class="nav-btn" onclick="switchTab('manage-pdfs')"><i class="fas fa-file-pdf"></i> Manage PDFs</button></li>
            </ul>
            <div style="margin-top: auto;">
                <button id="changePasswordBtn" class="nav-btn"><i class="fas fa-key"></i> Change Pass</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1 id="pageTitle">Dashboard</h1>
                <button id="adminLogoutBtn" class="logout-btn">Logout</button>
            </div>

            <div id="tab-dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-info"><h3 id="countUsers">0</h3><p>Total Users</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-info"><h3 id="countPending">0</h3><p>Pending Requests</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-video"></i></div>
                        <div class="stat-info"><h3 id="countVideos">0</h3><p>Videos Uploaded</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-file-pdf"></i></div>
                        <div class="stat-info"><h3 id="countPdfs">0</h3><p>PDF Materials</p></div>
                    </div>
                </div>
                <div class="card">
                    <h3>Quick Actions</h3>
                    <p style="color:#64748b; margin-bottom:10px;">Approve all pending users at once.</p>
                    <button id="approveAllBtn" class="migrate-btn" style="background:#10b981;">Approve All Pending</button>
                </div>
            </div>

            <div id="tab-users" class="content-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3>Registered Users</h3>
                        <button id="migrateLegacyBtn" class="migrate-btn"><i class="fas fa-check-double"></i> Approve All Existing Users</button>
                    </div>
                    <div class="filter-bar">
                        <input type="text" id="userSearch" class="search-input" placeholder="Search by username or email...">
                        <select id="userFilter" class="filter-select">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead><tr><th>Username</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-content" class="content-section">
                <div class="card">
                    <h3><i class="fas fa-video"></i> Add New Video</h3>
                    <form id="addVideoForm">
                        <div class="form-grid">
                            <input type="text" id="videoUrl" class="input-field" placeholder="YouTube URL or ID" required>
                            <input type="text" id="videoTitle" class="input-field" placeholder="Video Title" required>
                        </div>
                        <textarea id="videoDescription" class="input-field" placeholder="Description (Optional)" rows="3"></textarea>
                        <button type="submit" class="submit-btn">Add Video</button>
                    </form>
                </div>
                <div class="card">
                    <h3><i class="fas fa-file-pdf"></i> Upload PDF Material</h3>
                    <form id="uploadPdfForm">
                        <div class="form-grid">
                            <input type="text" id="pdfTitle" class="input-field" placeholder="PDF Title" required>
                            <input type="file" id="pdfFile" class="input-field" accept=".pdf" required>
                        </div>
                        <button type="submit" id="uploadPdfBtn" class="submit-btn">Upload PDF</button>
                    </form>
                </div>
            </div>

            <div id="tab-manage-videos" class="content-section">
                <div class="card">
                    <h3>Manage Videos</h3>
                    <table>
                        <thead><tr><th>Title</th><th>ID</th><th>Actions</th></tr></thead>
                        <tbody id="video-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-manage-pdfs" class="content-section">
                <div class="card">
                    <h3>Manage PDFs</h3>
                    <table>
                        <thead><tr><th>Title</th><th>Actions</th></tr></thead>
                        <tbody id="pdf-table-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="customAlertModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <i class="fas fa-info-circle modal-icon" id="alertIcon" style="color:var(--primary-color);"></i>
            <h3 class="modal-title" id="alertTitle">Alert</h3>
            <p class="modal-msg" id="alertMessage">Something happened.</p>
            <div class="modal-actions">
                <button class="modal-btn btn-confirm-primary" onclick="closeCustomAlert()">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <i class="fas fa-exclamation-triangle modal-icon" style="color:var(--warning);"></i>
            <h3 class="modal-title" id="confirmTitle">Are you sure?</h3>
            <p class="modal-msg" id="confirmMessage">Do you really want to perform this action?</p>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" id="confirmCancelBtn">Cancel</button>
                <button class="modal-btn btn-confirm-danger" id="confirmOkBtn">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <template id="passwordChangeTemplate">
        </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, addDoc, serverTimestamp, deleteDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, sendPasswordResetEmail, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzv4pdvSb6CEQrnGZ6qBc_gZWledDBI1XZ9FsP2hYTUd6YQ4bBCmFDjT2WdtpaHFBDjw/exec";
        
        const firebaseConfig = {
            apiKey: "AIzaSyASA8KptfOy9pezf3QCoWHt9Bg28yN3HsM",
            authDomain: "amce-5d785.firebaseapp.com",
            projectId: "amce-5d785",
            storageBucket: "amce-5d785.appspot.com",
            messagingSenderId: "877483628426",
            appId: "1:877483628426:web:dfd8961b06c35e6cc95a73"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allUsers = [];
        let confirmCallback = null; // Stores the function to run on "Yes"

        // --- CUSTOM ALERT & CONFIRM LOGIC ---
        window.showCustomAlert = function(title, message, isSuccess = true) {
            const modal = document.getElementById('customAlertModal');
            const icon = document.getElementById('alertIcon');
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = message;
            
            if (isSuccess) {
                icon.className = "fas fa-check-circle modal-icon";
                icon.style.color = "var(--success)";
            } else {
                icon.className = "fas fa-times-circle modal-icon";
                icon.style.color = "var(--danger)";
            }
            modal.style.display = "flex";
        };

        window.closeCustomAlert = function() {
            document.getElementById('customAlertModal').style.display = "none";
        };

        window.showCustomConfirm = function(title, message, callback, isDanger = true) {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            
            const okBtn = document.getElementById('confirmOkBtn');
            if(isDanger) {
                okBtn.className = "modal-btn btn-confirm-danger";
            } else {
                okBtn.className = "modal-btn btn-confirm-success";
            }

            confirmCallback = callback;
            modal.style.display = "flex";
        };

        // Confirm Modal Buttons
        document.getElementById('confirmCancelBtn').onclick = () => {
            document.getElementById('customConfirmModal').style.display = "none";
            confirmCallback = null;
        };

        document.getElementById('confirmOkBtn').onclick = () => {
            document.getElementById('customConfirmModal').style.display = "none";
            if (confirmCallback) confirmCallback();
        };

        // --- TABS LOGIC ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            const titles = { 
                'dashboard': 'Dashboard', 
                'users': 'User Management', 
                'content': 'Upload Content', 
                'manage-videos': 'Manage Videos',
                'manage-pdfs': 'Manage PDFs' 
            };
            document.getElementById('pageTitle').innerText = titles[tabName];
        };

        // --- AUTH LOGIC ---
        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard-view');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().isAdmin === true) {
                    loginView.style.display = 'none';
                    dashboardView.classList.remove('hidden');
                    loadAllData();
                } else {
                    await signOut(auth);
                    showCustomAlert("Access Denied", "You are not an authorized admin.", false);
                }
            } else {
                loginView.style.display = 'flex';
                dashboardView.classList.add('hidden');
            }
        });

        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            try {
                await setPersistence(auth, browserSessionPersistence);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('loginError').textContent = "Invalid Credentials";
            }
        });

        document.getElementById('adminLogoutBtn').addEventListener('click', () => signOut(auth));

        function loadAllData() {
            loadUsers();
            // Only load tables if they exist in current DOM (Safety)
            if (document.getElementById('video-table-body')) loadVideos();
            if (document.getElementById('pdf-table-body')) loadPdfs();
        }

        // --- USER MANAGEMENT ---
        async function loadUsers() {
            const tbody = document.getElementById('user-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';
            
            const q = query(collection(db, 'users'));
            const snapshot = await getDocs(q);
            
            allUsers = [];
            snapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
            
            updateStats();
            renderUserTable(allUsers);
        }

        function updateStats() {
            const countUsers = document.getElementById('countUsers');
            const countPending = document.getElementById('countPending');
            if(countUsers) countUsers.innerText = allUsers.length;
            if(countPending) countPending.innerText = allUsers.filter(u => u.isApproved !== true).length;
        }

        function renderUserTable(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">No users found.</td></tr>';
                return;
            }

            users.forEach(user => {
                const isApproved = user.isApproved === true;
                const statusBadge = isApproved 
                    ? '<span class="badge active">Active</span>' 
                    : '<span class="badge pending">Pending</span>';

                const approvalBtn = isApproved
                    ? `<button class="action-btn btn-suspend suspend-user-btn" data-uid="${user.id}">Suspend</button>`
                    : `<button class="action-btn btn-approve approve-user-btn" data-uid="${user.id}">Approve</button>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${user.username || 'N/A'}</strong></td>
                    <td>${user.email}</td>
                    <td>${user.mobile || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${approvalBtn}
                        <button class="action-btn btn-reset reset-pass-btn" data-email="${user.email}">Reset</button>
                        <button class="action-btn btn-delete delete-user-btn" data-uid="${user.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Filter Logic
        const userSearch = document.getElementById('userSearch');
        const userFilter = document.getElementById('userFilter');
        function filterUsers() {
            const term = userSearch.value.toLowerCase();
            const type = userFilter.value;
            const filtered = allUsers.filter(user => {
                const matchesText = (user.username && user.username.toLowerCase().includes(term)) || (user.email && user.email.toLowerCase().includes(term));
                let matchesType = true;
                if (type === 'active') matchesType = user.isApproved === true;
                if (type === 'pending') matchesType = user.isApproved !== true;
                return matchesText && matchesType;
            });
            renderUserTable(filtered);
        }
        if (userSearch && userFilter) {
            userSearch.addEventListener('input', filterUsers);
            userFilter.addEventListener('change', filterUsers);
        }

        // --- GLOBAL ACTIONS (WITH CUSTOM MODALS) ---
        document.body.addEventListener('click', async (e) => {
            const target = e.target;

            // Approve
            if (target.classList.contains('approve-user-btn')) {
                const uid = target.dataset.uid;
                target.innerText = "...";
                try {
                    await updateDoc(doc(db, 'users', uid), { isApproved: true });
                    // Update Local
                    const u = allUsers.find(x => x.id === uid); if(u) u.isApproved = true;
                    filterUsers(); updateStats();
                    showCustomAlert("Success", "User approved successfully!");
                } catch (err) { showCustomAlert("Error", err.message, false); }
            }

            // Suspend
            if (target.classList.contains('suspend-user-btn')) {
                const uid = target.dataset.uid;
                showCustomConfirm("Suspend User?", "They will lose access to the platform.", async () => {
                    try {
                        await updateDoc(doc(db, 'users', uid), { isApproved: false });
                        const u = allUsers.find(x => x.id === uid); if(u) u.isApproved = false;
                        filterUsers(); updateStats();
                        showCustomAlert("Suspended", "User access revoked.");
                    } catch (err) { showCustomAlert("Error", err.message, false); }
                });
            }

            // Delete User
            if (target.classList.contains('delete-user-btn')) {
                const uid = target.dataset.uid;
                showCustomConfirm("Delete User?", "This action cannot be undone.", async () => {
                    try {
                        await deleteDoc(doc(db, 'users', uid));
                        allUsers = allUsers.filter(u => u.id !== uid);
                        filterUsers(); updateStats();
                        showCustomAlert("Deleted", "User removed from database.");
                    } catch (err) { showCustomAlert("Error", err.message, false); }
                });
            }

            // Delete Content
            if (target.classList.contains('delete-content-btn')) {
                const id = target.dataset.id;
                const type = target.dataset.type;
                showCustomConfirm("Delete Item?", "This will remove it from the course list.", async () => {
                    try {
                        await deleteDoc(doc(db, type, id));
                        target.closest('tr').remove();
                        showCustomAlert("Deleted", "Item removed.");
                    } catch (err) { showCustomAlert("Error", err.message, false); }
                });
            }
        });
        
        // Bulk Actions
        document.getElementById('migrateLegacyBtn').addEventListener('click', () => {
            showCustomConfirm("Approve All Existing?", "This will unlock access for ALL current users.", async () => {
                const btn = document.getElementById('migrateLegacyBtn');
                btn.disabled = true; btn.innerText = "Processing...";
                for (const user of allUsers) {
                    if (user.isApproved !== true) {
                        await updateDoc(doc(db, 'users', user.id), { isApproved: true });
                    }
                }
                loadUsers();
                showCustomAlert("Success", "All existing users approved!");
                btn.disabled = false; btn.innerText = "Approve All Existing Users";
            }, false); // Not danger
        });

        document.getElementById('approveAllBtn').addEventListener('click', () => {
            showCustomConfirm("Approve All Pending?", "All pending requests will be granted access.", async () => {
                const pending = allUsers.filter(u => u.isApproved !== true);
                for (const user of pending) {
                    await updateDoc(doc(db, 'users', user.id), { isApproved: true });
                }
                loadUsers();
                showCustomAlert("Success", "All pending users approved!");
            }, false);
        });

        // --- DATA LOADING ---
        async function loadVideos() {
            const tbody = document.getElementById('video-table-body');
            if(!tbody) return;
            const q = query(collection(db, 'videos'), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            if(document.getElementById('countVideos')) document.getElementById('countVideos').innerText = snap.size;
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.title}</td><td style="font-family:monospace;">${d.id}</td><td><button class="action-btn btn-delete delete-content-btn" data-id="${doc.id}" data-type="videos">Delete</button></td>`;
                tbody.appendChild(tr);
            });
        }

        async function loadPdfs() {
            const tbody = document.getElementById('pdf-table-body');
            if(!tbody) return;
            const q = query(collection(db, 'pdfs'), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            if(document.getElementById('countPdfs')) document.getElementById('countPdfs').innerText = snap.size;
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.title}</td><td><button class="action-btn btn-delete delete-content-btn" data-id="${doc.id}" data-type="pdfs">Delete</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- FORMS ---
        document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (Validation same as before)
            const url = document.getElementById('videoUrl').value;
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const vidId = url.match(regex)?.[1] || (url.length === 11 ? url : null);
            
            if(!vidId) { showCustomAlert("Error", "Invalid ID", false); return; }

            try {
                await addDoc(collection(db, "videos"), { 
                    id: vidId, 
                    title: document.getElementById('videoTitle').value, 
                    description: document.getElementById('videoDescription').value, 
                    createdAt: serverTimestamp() 
                });
                showCustomAlert("Success", "Video added!");
                document.getElementById('addVideoForm').reset();
                loadVideos();
            } catch (err) { showCustomAlert("Error", err.message, false); }
        });

        document.getElementById('uploadPdfForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('pdfFile').files[0];
            const title = document.getElementById('pdfTitle').value;
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async (event) => {
                try {
                    const payload = { file: event.target.result, type: file.type, name: file.name };
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const data = await res.json();
                    if (data.status === 'success') {
                        await addDoc(collection(db, "pdfs"), { title, url: data.url, fileId: data.fileId, createdAt: serverTimestamp() });
                        showCustomAlert("Success", "PDF Uploaded!");
                        document.getElementById('uploadPdfForm').reset();
                        loadPdfs();
                    } else { throw new Error(data.message); }
                } catch (err) { showCustomAlert("Error", err.message, false); }
            };
        });
    </script>
</body>
</html>